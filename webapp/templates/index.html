<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Planning Copilot</title>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <div class="app">
      <header class="app__header">
        <div class="header__title">Planning Copilot</div>
        <div class="header__subtitle">
          Craft a domain/problem from natural language and get the validated plan.
        </div>
        <div class="header__actions">
          <button type="button" id="api-key-btn" class="outline-button">API Key</button>
          <button type="button" id="clear-btn" class="clear-button">Clear</button>
        </div>
      </header>

      <main class="app__main">
        <section class="panel panel--input">
          <form class="prompt-form" autocomplete="off">
            <label for="prompt" class="prompt-form__label">Describe the task</label>
            <div class="prompt-form__input">
              <textarea
                id="prompt"
                name="prompt"
                placeholder="e.g. Schedule a 30 minute meeting for Alice, Bob, and Carol next Monday afternoon..."
                required
              ></textarea>
              <img
                src="{{ url_for('static', filename='cat-icon.svg') }}"
                alt=""
                class="prompt-form__icon"
                aria-hidden="true"
              />
            </div>

            <div class="prompt-form__controls">
              <div class="control-group">
                <label for="model_json">Representation model</label>
                <select id="model_json" name="model_json">
                  {% for option in model_options %}
                  <option value="{{ option }}" {% if option == default_model_json %}selected{% endif %}>
                    {{ option }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="control-group">
                <label for="model_plan">Planning model</label>
                <select id="model_plan" name="model_plan">
                  {% for option in model_options %}
                  <option value="{{ option }}" {% if option == default_model_plan %}selected{% endif %}>
                    {{ option }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="control-group">
                <label for="target_solver">Solver</label>
                <select id="target_solver" name="target_solver">
                  {% for option in solver_options %}
                  <option value="{{ option }}" {% if option == default_target_solver %}selected{% endif %}>
                    {{ option }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="control-group">
                <label for="optimize_plan">Optimise plan?</label>
                <select id="optimize_plan" name="optimize_plan">
                  {% for value, label in optimize_options %}
                  <option value="{{ value }}" {% if value == default_optimize %}selected{% endif %}>
                    {{ label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
              <div class="control-group">
                <label for="budget">Refinement budget</label>
                <input
                  type="number"
                  id="budget"
                  name="budget"
                  min="1"
                  max="50"
                  value="{{ default_budget }}"
                />
              </div>
            </div>

            <button type="submit" class="prompt-form__submit">Plan</button>
          </form>
        </section>

        <section id="logs-panel" class="panel panel--logs" hidden>
          <div class="progress">
            <div class="progress__label">
              Iteration progress <span id="progress-value">0%</span>
            </div>
            <div class="progress__bar">
              <div id="progress-bar-fill" class="progress__fill" style="width: 0%"></div>
            </div>
          </div>
          <details class="log-view">
            <summary>
              <span class="spinner" aria-hidden="true"></span>
              <span>Thinking and logs…</span>
            </summary>
            <pre id="logs-output" hidden></pre>
            <div class="log-placeholder">
              Logs will appear here as soon as they are generated.
            </div>
          </details>
        </section>

        <section class="panel panel--output">
          <div id="user-prompt" class="chat-bubble chat-bubble--user" hidden>
            <div class="chat-bubble__label">You</div>
            <div class="chat-bubble__body"></div>
          </div>

          <details id="domain-section" class="artifact" open hidden>
            <summary>Domain</summary>
            <pre id="domain-body">Waiting for domain...</pre>
          </details>

          <details id="problem-section" class="artifact" open hidden>
            <summary>Problem</summary>
            <pre id="problem-body">Waiting for problem...</pre>
          </details>

          <details id="plan-section" class="artifact" open hidden>
            <summary>Plan</summary>
            <div id="plan-empty" class="artifact__placeholder" hidden>No plan generated yet.</div>
            <pre id="plan-body" hidden></pre>
          </details>

          <div id="planner-response" class="chat-bubble chat-bubble--assistant" hidden>
            <div class="chat-bubble__label">Planner</div>
            <pre class="chat-bubble__body"></pre>
            <div class="chat-meta"></div>
          </div>

          <div
            id="planner-error"
            class="chat-bubble chat-bubble--assistant chat-bubble--error"
            hidden
          >
            <div class="chat-bubble__label">Planner</div>
            <div class="chat-bubble__body"></div>
          </div>

          <div id="empty-state" class="empty-state">
            <div class="empty-state__title">Waiting for your task</div>
            <div class="empty-state__body">
              Describe a scheduling or planning scenario and I'll validate or repair it using the multi-agent pipeline.
            </div>
          </div>
        </section>
      </main>

      <footer class="app__footer">
        <span>Powered by MultiAgentPlanning</span>
      </footer>
    </div>

    <div id="api-key-modal" class="modal" hidden>
      <div class="modal__overlay"></div>
      <div class="modal__content">
        <h2>ChatGPT API Key</h2>
        <p class="modal__description">
          Provide the OpenAI API key used by the planner.
        </p>
        <div class="modal__body">
          <div id="current-key-wrapper" class="modal__field" hidden>
            <label for="current-api-key">Current key</label>
            <input
              id="current-api-key"
              type="password"
              readonly
              value=""
              autocomplete="off"
            />
          </div>
          <div class="modal__field">
            <label for="new-api-key">New key</label>
            <input
              id="new-api-key"
              type="password"
              placeholder="sk-..."
              autocomplete="off"
            />
          </div>
          <div id="api-key-error" class="modal__error" hidden></div>
        </div>
        <div class="modal__actions">
          <button type="button" id="api-key-cancel" class="outline-button">
            Cancel
          </button>
          <button type="button" id="api-key-save" class="primary-button">
            Save
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const form = document.querySelector(".prompt-form");
        const promptInput = document.getElementById("prompt");
        const modelJsonSelect = document.getElementById("model_json");
        const modelPlanSelect = document.getElementById("model_plan");
        const solverSelect = document.getElementById("target_solver");
        const optimizeSelect = document.getElementById("optimize_plan");
        const budgetInput = document.getElementById("budget");
        const logsPanel = document.getElementById("logs-panel");
        const logDetails = logsPanel.querySelector("details");
        const spinner = logsPanel.querySelector(".spinner");
        const logsOutput = document.getElementById("logs-output");
        const logsPlaceholder = logsPanel.querySelector(".log-placeholder");
        const userPromptBubble = document.getElementById("user-prompt");
        const userPromptBody = userPromptBubble.querySelector(".chat-bubble__body");
        const plannerResponseBubble = document.getElementById("planner-response");
        const plannerResponseBody = plannerResponseBubble.querySelector(".chat-bubble__body");
        const plannerMeta = plannerResponseBubble.querySelector(".chat-meta");
        const plannerErrorBubble = document.getElementById("planner-error");
        const plannerErrorBody = plannerErrorBubble.querySelector(".chat-bubble__body");
        const emptyState = document.getElementById("empty-state");
        const clearButton = document.getElementById("clear-btn");
        const apiKeyBtn = document.getElementById("api-key-btn");
        const apiKeyModal = document.getElementById("api-key-modal");
        const apiKeyOverlay = apiKeyModal.querySelector(".modal__overlay");
        const currentKeyWrapper = document.getElementById("current-key-wrapper");
        const currentKeyInput = document.getElementById("current-api-key");
        const newKeyInput = document.getElementById("new-api-key");
        const apiKeyError = document.getElementById("api-key-error");
        const apiKeyCancel = document.getElementById("api-key-cancel");
        const apiKeySave = document.getElementById("api-key-save");
        const progressValue = document.getElementById("progress-value");
        const progressBarFill = document.getElementById("progress-bar-fill");
        const domainSection = document.getElementById("domain-section");
        const problemSection = document.getElementById("problem-section");
        const planSection = document.getElementById("plan-section");
        const domainBody = document.getElementById("domain-body");
        const problemBody = document.getElementById("problem-body");
        const planBody = document.getElementById("plan-body");
        const planEmpty = document.getElementById("plan-empty");
        const floatingCat = document.getElementById("floating-cat");

        let jobId = null;
        let pollInterval = null;
        let thinkingDotsInterval = null;
        let dotsCount = 1;
        let totalBudget = Number(budgetInput.value) || 1;
        let iterationsCompleted = 0;

        const resetOutput = () => {
          stopThinkingDots();
          userPromptBubble.hidden = true;
          plannerResponseBubble.hidden = true;
          plannerErrorBubble.hidden = true;
          plannerMeta.textContent = "";
          plannerResponseBody.textContent = "";
          plannerErrorBody.textContent = "";
          emptyState.hidden = false;
          iterationsCompleted = 0;
          totalBudget = Number(budgetInput.value) || 1;
          updateProgressBar();
          hideArtifacts();
        };

        const hideFloatingCat = () => {
          if (floatingCat) {
            floatingCat.classList.remove("show");
            floatingCat.hidden = true;
          }
        };

        let catAnimationBound = false;

        const randomBetween = (min, max) => min + Math.random() * (max - min);

        const configureFloatingCat = () => {
          if (!floatingCat) return;
          const viewportWidth = window.innerWidth || 1920;
          const viewportHeight = window.innerHeight || 1080;

          const fromLeft = Math.random() < 0.5;
          const startXNum = fromLeft ? -0.35 * viewportWidth : 1.35 * viewportWidth;
          const endXNum = fromLeft ? 1.35 * viewportWidth : -0.35 * viewportWidth;
          const startYNum = randomBetween(0.1, 0.9) * viewportHeight;
          const endYNum = randomBetween(0.1, 0.9) * viewportHeight;

          const makeMidPoint = (t, variance = 0.15) => {
            const baseX = startXNum + (endXNum - startXNum) * t;
            const baseY = startYNum + (endYNum - startYNum) * t;
            const jitterX = (Math.random() - 0.5) * variance * viewportWidth;
            const jitterY = (Math.random() - 0.5) * variance * viewportHeight;
            return {
              x: baseX + jitterX,
              y: baseY + jitterY,
            };
          };

          const mid1 = makeMidPoint(0.25);
          const mid2 = makeMidPoint(0.5);
          const mid3 = makeMidPoint(0.75);

          const toVW = (value) => `${(value / viewportWidth) * 100}vw`;
          const toVH = (value) => `${(value / viewportHeight) * 100}vh`;

          floatingCat.style.setProperty("--cat-start-x", toVW(startXNum));
          floatingCat.style.setProperty("--cat-end-x", toVW(endXNum));
          floatingCat.style.setProperty("--cat-start-y", toVH(startYNum));
          floatingCat.style.setProperty("--cat-end-y", toVH(endYNum));
          floatingCat.style.setProperty("--cat-mid1-x", toVW(mid1.x));
          floatingCat.style.setProperty("--cat-mid1-y", toVH(mid1.y));
          floatingCat.style.setProperty("--cat-mid2-x", toVW(mid2.x));
          floatingCat.style.setProperty("--cat-mid2-y", toVH(mid2.y));
          floatingCat.style.setProperty("--cat-mid3-x", toVW(mid3.x));
          floatingCat.style.setProperty("--cat-mid3-y", toVH(mid3.y));

          const fastBurst = Math.random() < 0.25;
          const duration = fastBurst ? randomBetween(2.2, 3.8) : randomBetween(8, 16);
          floatingCat.style.setProperty("--cat-duration", `${duration}s`);

          const timings = [
            "ease-in-out",
            "cubic-bezier(0.42, 0, 0.58, 1)",
            "cubic-bezier(0.68, -0.55, 0.27, 1.55)",
            "cubic-bezier(0.22, 1, 0.36, 1)",
            "linear",
          ];
          floatingCat.style.setProperty(
            "--cat-timing",
            timings[Math.floor(Math.random() * timings.length)]
          );
        };

        const showFloatingCat = () => {
          if (!floatingCat) return;
          configureFloatingCat();
          floatingCat.hidden = false;
          floatingCat.classList.remove("show");
          void floatingCat.offsetWidth;
          floatingCat.classList.add("show");
          if (!catAnimationBound) {
            floatingCat.addEventListener("animationiteration", () => {
              configureFloatingCat();
            });
            catAnimationBound = true;
          }
        };

        const stopPolling = () => {
          if (pollInterval) {
            clearInterval(pollInterval);
            pollInterval = null;
          }
          stopThinkingDots();
          spinner.classList.remove("spinner--active");
          document.body.classList.remove("submitting");
          hideFloatingCat();
        };

        const stopThinkingDots = () => {
          if (thinkingDotsInterval) {
            clearInterval(thinkingDotsInterval);
            thinkingDotsInterval = null;
          }
          hideFloatingCat();
        };

        const startThinkingDots = () => {
          stopThinkingDots();
          plannerErrorBubble.hidden = true;
          plannerResponseBubble.hidden = false;
          plannerMeta.textContent = "";
          dotsCount = 1;
          plannerResponseBody.textContent = ".".repeat(dotsCount);
          thinkingDotsInterval = setInterval(() => {
            dotsCount = dotsCount % 5 + 1;
            plannerResponseBody.textContent = ".".repeat(dotsCount);
          }, 400);
          showFloatingCat();
        };

        const updateProgressBar = () => {
          const pct = Math.min(100, Math.round((iterationsCompleted / totalBudget) * 100));
          progressValue.textContent = `${pct}%`;
          progressBarFill.style.width = `${pct}%`;
        };

        const showArtifacts = (artifacts) => {
          if (!artifacts) return;
          const { domain = "", problem = "", plan = "" } = artifacts;
          if (domain) {
            domainSection.hidden = false;
            domainBody.textContent = domain;
          }
          if (problem) {
            problemSection.hidden = false;
            problemBody.textContent = problem;
          }
          if (plan) {
            planSection.hidden = false;
            planEmpty.hidden = true;
            planBody.hidden = false;
            planBody.textContent = plan;
          } else {
            planSection.hidden = false;
            planEmpty.hidden = false;
            planBody.hidden = true;
          }
        };

        const hideArtifacts = () => {
          domainSection.hidden = true;
          problemSection.hidden = true;
          planSection.hidden = true;
          domainBody.textContent = "";
          problemBody.textContent = "";
          planBody.textContent = "";
          planEmpty.hidden = true;
        };

        const updateLogs = (text) => {
          if (text) {
            logsPlaceholder.hidden = true;
            logsOutput.hidden = false;
            logsOutput.textContent = text;
          } else {
            logsOutput.hidden = true;
            logsPlaceholder.hidden = false;
            logsOutput.textContent = "";
          }
        };

        const renderSummary = (summary) => {
          stopThinkingDots();
          emptyState.hidden = true;
          if (summary?.natural_plan) {
            plannerErrorBubble.hidden = true;
            plannerResponseBubble.hidden = false;
            plannerResponseBody.textContent = summary.natural_plan;
            plannerMeta.textContent = summary.base_folder
              ? `Artifacts stored in: ${summary.base_folder}`
              : "";
          } else {
            plannerResponseBubble.hidden = true;
            plannerErrorBubble.hidden = false;
            const message = summary?.error || "No plan was produced.";
            plannerErrorBody.textContent = message;
          }
          iterationsCompleted = totalBudget;
          updateProgressBar();
        };

        const pollLogs = () => {
          if (!jobId) return;
          fetch(`/logs/${jobId}`)
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                plannerResponseBubble.hidden = true;
                stopThinkingDots();
                plannerErrorBubble.hidden = false;
                plannerErrorBody.textContent = data.error;
                stopPolling();
                return;
              }
              if (typeof data.logs === "string") {
                updateLogs(data.logs);
              }
              if (data.artifacts) {
                showArtifacts(data.artifacts);
              }
              if (typeof data.iterations_completed === "number") {
                iterationsCompleted = data.iterations_completed;
                totalBudget = Math.max(1, Number(data.total_budget || totalBudget));
                updateProgressBar();
              }

              if (data.status === "completed" || data.status === "failed") {
                stopPolling();
                if (data.summary) {
                  renderSummary(data.summary);
                } else {
                  plannerResponseBubble.hidden = true;
                  plannerErrorBubble.hidden = false;
                  plannerErrorBody.textContent =
                    "Workflow completed but no summary was returned.";
                  iterationsCompleted = totalBudget;
                  updateProgressBar();
                }
                hideFloatingCat();
              }
            })
            .catch((error) => {
              stopThinkingDots();
              plannerResponseBubble.hidden = true;
              plannerErrorBubble.hidden = false;
              plannerErrorBody.textContent = `Error fetching logs: ${error}`;
              stopPolling();
              hideFloatingCat();
            });
        };

        form.addEventListener("submit", (event) => {
          event.preventDefault();
          stopPolling();
          jobId = null;
          const prompt = promptInput.value.trim();
          if (!prompt) {
            promptInput.focus();
            return;
          }

          resetOutput();

          userPromptBubble.hidden = false;
          userPromptBody.textContent = prompt;
          emptyState.hidden = true;

          logsPanel.hidden = false;
          logDetails.setAttribute("open", "open");
          spinner.classList.add("spinner--active");
          updateLogs("");
          document.body.classList.add("submitting");
          startThinkingDots();

          const payload = {
            prompt,
            model_json: modelJsonSelect.value,
            model_plan: modelPlanSelect.value,
            target_solver: solverSelect.value,
            optimize_plan: optimizeSelect.value,
            budget: budgetInput.value,
          };

          fetch("/start_run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.error) {
                plannerResponseBubble.hidden = true;
                stopThinkingDots();
                plannerErrorBubble.hidden = false;
                plannerErrorBody.textContent = data.error;
                spinner.classList.remove("spinner--active");
                document.body.classList.remove("submitting");
                return;
              }
              jobId = data.job_id;
              iterationsCompleted = Number(data.iterations_completed || 0);
              totalBudget = Math.max(1, Number(data.total_budget || budgetInput.value));
              updateProgressBar();
              pollLogs();
              pollInterval = setInterval(pollLogs, 10000);
            })
            .catch((error) => {
              plannerResponseBubble.hidden = true;
              stopThinkingDots();
              plannerErrorBubble.hidden = false;
              plannerErrorBody.textContent = `Failed to start planner: ${error}`;
              spinner.classList.remove("spinner--active");
              document.body.classList.remove("submitting");
            });
        });

        clearButton.addEventListener("click", () => {
          fetch("/clear", { method: "POST" })
            .finally(() => window.location.reload());
        });

        const openApiKeyModal = () => {
          apiKeyError.hidden = true;
          apiKeyError.style.color = "var(--error)";
          apiKeyError.textContent = "";
          newKeyInput.value = "";
          fetch("/api_key")
            .then((response) => response.json())
            .then((data) => {
              if (data.has_key) {
                currentKeyWrapper.hidden = false;
                currentKeyInput.value = data.masked || "••••";
              } else {
                currentKeyWrapper.hidden = true;
                currentKeyInput.value = "";
              }
            })
            .catch(() => {
              currentKeyWrapper.hidden = true;
              currentKeyInput.value = "";
            })
            .finally(() => {
              apiKeyModal.hidden = false;
              newKeyInput.focus();
            });
        };

        const closeApiKeyModal = () => {
          apiKeyModal.hidden = true;
          apiKeyError.hidden = true;
          apiKeyError.style.color = "var(--error)";
          apiKeyError.textContent = "";
          newKeyInput.value = "";
        };

        apiKeyBtn.addEventListener("click", openApiKeyModal);
        apiKeyOverlay.addEventListener("click", closeApiKeyModal);
        apiKeyCancel.addEventListener("click", closeApiKeyModal);

        apiKeySave.addEventListener("click", () => {
          const keyValue = newKeyInput.value.trim();
          if (!keyValue) {
            apiKeyError.hidden = false;
            apiKeyError.style.color = "var(--error)";
            apiKeyError.textContent = "Please provide an API key.";
            newKeyInput.focus();
            return;
          }

          fetch("/api_key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ openai_api_key: keyValue }),
          })
            .then((response) => response.json().then((data) => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
              if (!ok) {
                apiKeyError.hidden = false;
                apiKeyError.style.color = "var(--error)";
                apiKeyError.textContent = data.error || "Failed to save the key.";
                return;
              }
              currentKeyWrapper.hidden = false;
              currentKeyInput.value = data.masked || "••••";
              apiKeyError.hidden = false;
              apiKeyError.textContent = "API key saved.";
              apiKeyError.style.color = "#166534";
              setTimeout(() => {
                apiKeyError.hidden = true;
                apiKeyError.textContent = "";
                apiKeyError.style.color = "var(--error)";
                closeApiKeyModal();
              }, 1200);
            })
            .catch(() => {
              apiKeyError.hidden = false;
              apiKeyError.style.color = "var(--error)";
              apiKeyError.textContent = "Unexpected error while saving the key.";
            });
        });

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && !apiKeyModal.hidden) {
            closeApiKeyModal();
          }
        });

        hideArtifacts();
        updateProgressBar();
      });
    </script>
    <img src="{{ url_for('static', filename='gatozzo-planner.webp') }}" alt="" id="floating-cat" hidden />
  </body>
</html>
